import SQL from '@nearform/sql'

// This route exposes all users and their passwords for the purposes of simulating a data breach
export default async function register(fastify) {
  fastify.get('/all-data', async (req, reply) => {
    reply.header('Access-Control-Allow-Origin', '*')
    reply.header('Access-Control-Allow-Methods', 'GET')
    reply.header('Access-Control-Allow-Headers', 'Content-Type, Authorization')

    const { rows } = await fastify.pg.query(
      SQL`SELECT username, password FROM users`
    )

    return rows
  })

  fastify.options('/all-data', (req, reply) => {
    reply.header('Access-Control-Allow-Origin', '*')
    reply.header(
      'Access-Control-Allow-Methods',
      'GET, POST, PUT, DELETE, OPTIONS'
    )
    reply.header('Access-Control-Allow-Headers', 'Content-Type, Authorization')
    reply.send()
  })
}
